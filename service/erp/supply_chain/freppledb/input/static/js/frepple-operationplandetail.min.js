/* frePPLe 4.0.0
Copyright (C) 2010-2019 by frePPLe bv

Permission is hereby granted, free of charge, to any person obtaining
a copy of this software and associated documentation files(the
"Software"), to deal in the Software without restriction, including
without limitation the rights to use, copy, modify, merge, publish,
distribute, sublicense, and/ or sell copies of the Software, and to
permit persons to whom the Software is furnished to do so, subject to
the following conditions:

The above copyright notice and this permission notice shall be
included in all copies or substantial portions of the Software.

THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND,
EXPRESS OR IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF
MERCHANTABILITY, FITNESS FOR A PARTICULAR PURPOSE AND
NONINFRINGEMENT.IN NO EVENT SHALL THE AUTHORS OR COPYRIGHT HOLDERS BE
LIABLE FOR ANY CLAIM, DAMAGES OR OTHER LIABILITY, WHETHER IN AN ACTION
OF CONTRACT, TORT OR OTHERWISE, ARISING FROM, OUT OF OR IN CONNECTION
WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE SOFTWARE.
*/

angular.module("calendar",[]).constant("calendarConfig",{formatDay:"d",formatDayHeader:"EEE",formatDayTitle:"MMMM dd, yyyy",formatWeekTitle:"MMMM yyyy, Week w",formatMonthTitle:"MMMM yyyy",formatWeekViewDayHeader:"EEE d",formatHourColumn:"ha",showWeeks:!0}).controller("calendarController",["$scope","$attrs","$parse","$interpolate","$log","dateFilter","gettextCatalog","calendarConfig","PreferenceSvc",function(e,t,a,n,r,o,i,d,l){"use strict";var p=this,s={$setViewValue:angular.noop};angular.forEach(["formatDay","formatDayHeader","formatDayTitle","formatWeekTitle","formatMonthTitle","formatWeekViewDayHeader","formatHourColumn"],function(a,r){p[a]=angular.isDefined(t[a])?n(t[a])(e.$parent):d[a]}),angular.forEach(["showWeeks"],function(a,n){p[a]=angular.isDefined(t[a])?e.$parent.$eval(t[a]):d[a]}),p.hourParts=3600;var c=e.$parent.$watch(t.eventSource,function(e){p.onEventSourceChanged(e)});e.$on("$destroy",c),e.admin_escape=admin_escape,e.url_prefix=url_prefix,e.scrollBarWidth=getScrollBarWidth(),e.calendarmode=calendarmode,e.grouping=grouping,e.groupingdir=groupingdir,e.grid=grid,e.groupingcfg=groupingcfg,e.calendarmodes={start:i.getString("View start events"),end:i.getString("View end events"),start_end:i.getString("View start and end events"),duration:i.getString("View full duration")},e.setCalendarMode=function(t){e.calendarmode=t,l.save("calendarmode",t)},e.setGrouping=function(t){e.grouping=t,l.save("grouping",t),p._onDataLoaded()},e.setGroupingDir=function(t){e.groupingdir=t,l.save("groupingdir",t),p._onDataLoaded()},angular.isDefined(t.initDate)&&(p.currentCalendarDate=e.$parent.$eval(t.initDate)),p.currentCalendarDate||(p.currentCalendarDate=currentdate,t.ngModel&&!e.$parent.$eval(t.ngModel)&&a(t.ngModel).assign(e.$parent,p.currentCalendarDate)),e.getHeight=function(e){if(preferences&&preferences.details&&"bottom"!=preferences.details){var t=angular.element(document).find("#content-main");return Math.max(150,$(window).height()-t.offset().top-e-40)}return preferences&&preferences.height?preferences.height-e:220-e},e.displayEvent=function(t,a){switch(e.calendarmode){case"duration":return!0;case"start_end":return moment(t.operationplan__startdate||t.startdate||t.operationplan__enddate||t.enddate).isSame(a.date,"day")||moment(t.operationplan__enddate||t.enddate||t.operationplan__startdate||t.startdate).isSame(a.date,"day");case"start":return moment(t.operationplan__startdate||t.startdate||t.operationplan__enddate||t.enddate).isSame(a.date,"day");case"end":return moment(t.operationplan__enddate||t.enddate||t.operationplan__startdate||t.startdate).isSame(a.date,"day")}},e.isStart=function(e,t){var a=e.startdate||e.operationplan__startdate;return!!a&&(t instanceof Date?a.getFullYear()===t.getFullYear()&&a.getMonth()===t.getMonth()&&a.getDate()===t.getDate():moment(a).isSame(t.date,"day"))},e.isEnd=function(e,t){var a=e.enddate||e.operationplan__enddate;return!!a&&(a>(e.startdate||e.operationplan__startdate)&&(a=new Date(a-1)),t instanceof Date?a.getFullYear()===t.getFullYear()&&a.getMonth()===t.getMonth()&&a.getDate()===t.getDate():moment(a).isSame(t.date,"day"))},e.displayEvent=function(t,a){switch(e.calendarmode){case"duration":return!0;case"start_end":return!!t.startdate&&moment(t.startdate).isSame(a.date,"day")||!!t.enddate&&moment(t.enddate>t.startdate?t.enddate-1:t.enddate).isSame(a.date,"day");case"start":return!!t.startdate&&moment(t.startdate).isSame(a.date,"day");case"end":return!!t.enddate&&moment(t.enddate>t.startdate?t.enddate-1:t.enddate).isSame(a.date,"day")}},p.init=function(e){(s=e).$render=function(){p.render()}},p.render=function(){if(s.$modelValue){var e=new Date(s.$modelValue),t=!isNaN(e);t?this.currentCalendarDate=e:r.error('"ng-model" value must be a Date object, a number of milliseconds since 01.01.1970 or a string representing an RFC2822 or ISO 8601 date.'),s.$setValidity("date",t)}this.refreshView()},p.refreshView=function(){this.mode&&(this.range=this._getRange(this.currentCalendarDate),this._refreshView(),this.rangeChanged())},p.split=function(e,t){for(var a=[];e.length>0;)a.push(e.splice(0,t));return a},p.onEventSourceChanged=function(e){p.eventSource=e,p._onDataLoaded&&p._onDataLoaded()},e.move=function(t){var a,n=p.mode.step,r=p.currentCalendarDate,o=r.getFullYear()+t*(n.years||0),i=r.getMonth()+t*(n.months||0),d=r.getDate()+t*(n.days||0);r.setFullYear(o,i,d),"calendarmonth"===e.mode&&(a=new Date(o,i+1,1)).getTime()<=r.getTime()&&(p.currentCalendarDate=new Date(a-864e5)),s.$setViewValue(p.currentCalendarDate),p.refreshView()},p.move=function(t){e.move(t)},p.changeMode=function(t){e.mode=t},p.rangeChanged=function(){e.rangeChanged?e.rangeChanged({startdate:this.range.startdate,enddate:this.range.enddate}):console.error("No rangeChanged callback is registered")}}]).directive("calendar",function(){"use strict";return{restrict:"EA",replace:!0,templateUrl:"/static/operationplandetail/calendar.html",scope:{mode:"=",editable:"=",rangeChanged:"&",eventSelected:"&",timeSelected:"&"},require:["calendar","?^ngModel"],controller:"calendarController",link:function(e,t,a,n){var r,o=n[0],i=n[1];function d(t){var a=new Date(t.originalEvent.dataTransfer.getData("dragstart")),n=new Date($(t.target).closest(".datecell").attr("data-date")),o=t.originalEvent.dataTransfer.getData("dragreference"),i=t.originalEvent.dataTransfer.getData("dragrow"),d=$(t.target).closest("[data-row]").attr("data-row");if("resource"!==e.grouping||i!=d||a.getTime()!==n.getTime()){if("resource"!==e.grouping&&a.getTime()===n.getTime())return t.preventDefault(),void(d=i);e.$apply(function(){for(var t of e.$parent.calendarevents)if((t.id||t.reference)==o){var l=!1;if(e.isStart(t,a))t.hasOwnProperty("operationplan__startdate")?(e.changeCard(t,"operationplan__startdate",t.operationplan__startdate,n),t.operationplan__startdate=n,t.startdate=n,t.operationplan__enddate<n&&(t.operationplan__enddate=n),l=!0):t.hasOwnProperty("startdate")&&(e.changeCard(t,"startdate",t.startdate,n),t.startdate=n,t.enddate<n&&(t.enddate=n),l=!0);else if(e.isEnd(t,a))t.hasOwnProperty("operationplan__enddate")?(e.changeCard(t,"operationplan__enddate",t.operationplan__enddate,n),t.operationplan__enddate=n,t.enddate=n,t.operationplan__startdate>n&&(t.operationplan__startdate=n),l=!0):t.hasOwnProperty("enddate")&&(e.changeCard(t,"enddate",t.enddate,n),t.enddate=n,t.startdate>n&&(t.startdate=n),l=!0);else{var p=(n-a)/864e5;if(t.hasOwnProperty("operationplan__startdate"))(s=new Date(t.operationplan__startdate)).setDate(t.operationplan__startdate.getDate()+p),e.changeCard(t,"operationplan__startdate",t.operationplan__startdate,s),t.operationplan__startdate=s,t.startdate=s,t.operationplan__enddate<s&&(t.operationplan__enddate=n),l=!0;else if(t.hasOwnProperty("startdate")){var s;(s=new Date(t.startdate)).setDate(t.startdate.getDate()+p),e.changeCard(t,"startdate",t.startdate,s),t.startdate=s,t.enddate<s&&(t.enddate=s),l=!0}}i!=d&&t.resource==i&&(e.changeCard(t,"resource",t.row_dragstart,d),t.resource=d,l=!0),l&&r&&r(t,!0);break}}),t.preventDefault()}else t.preventDefault()}function l(e){e.originalEvent.dataTransfer.setData("dragstart",$(e.target).closest(".datecell").attr("data-date")),e.originalEvent.dataTransfer.setData("dragreference",$(e.target).closest(".card").attr("data-reference")),e.originalEvent.dataTransfer.setData("dragrow",$(e.target).closest("[data-row]").attr("data-row")),e.stopPropagation()}function p(e){e.preventDefault()}function s(){t.off("dragover","td.datecell",p),t.off("drop","td.datecell",d),t.off("dragstart",".card",l),r=null}e.curselected=null,i&&o.init(i),e.$on("selectedEdited",function(t,a,n,r){if(null!==e.curselected&&(!e.mode||e.mode.startsWith("calendar")))if("loadplans"==a){var o=[];angular.forEach(r,function(e){o.push([e.resource.name,e.quantity])}),e.changeCard(e.curselected,"resource",e.curselected.resource,o),e.curselected.resource=o}else e.changeCard(e.curselected,a,n),e.curselected[a]=r}),e.$on("changeDate",function(e,t){o.move(t)}),e.$on("eventSourceChanged",function(e,t){o.onEventSourceChanged(t)}),e.selectCard=function(t){if(e.curselected){if(e.curselected.reference&&e.curselected.reference==t.reference&&t.selected)return;if(e.curselected.operationplan__reference&&e.curselected.operationplan__reference==t.reference&&t.selected)return;delete e.curselected.selected}t.selected=!0,e.curselected=t,e.eventSelected({event:t}),angular.element(document).find("#delete_selected, #gridactions").prop("disabled",!1)},e.changeCard=function(t,a,n,r){t.hasOwnProperty(a+"Original")||(t[a+"Original"]=n),t.dirty=!0,angular.element(document).find("#save, #undo").removeClass("btn-primary btn-danger").addClass("btn-danger").prop("disabled",!1),$(window).off("beforeunload",upload.warnUnsavedChanges),$(window).on("beforeunload",upload.warnUnsavedChanges),void 0!==r&&e.$parent.$broadcast("cardChanged",a,n,r)},e.enableDragDrop=function(e){s(),t.on("dragover","td.datecell",p),t.on("drop","td.datecell",d),t.on("dragstart",".card",l),r=e},e.disableDragDrop=s}}}).directive("monthview",["dateFilter",function(e){"use strict";return{restrict:"EA",replace:!0,templateUrl:"/static/operationplandetail/month.html",require:["^calendar","?^ngModel"],link:function(t,a,n,r){var o=r[0],i=r[1];function d(t,a){return{date:t,label:e(t,a),selected:0===o.compare(t,o.currentCalendarDate),current:0===o.compare(t,currentdate)}}function l(e,t){return(e.startdate?e.startdate:e.enddate).getTime()-(t.startdate?t.startdate:t.enddate)}function p(e,a){var n,r,i,d,l=e.startdate?new Date(e.startdate):null,p=e.enddate?new Date(e.enddate):null;if((p||l)<=o.range.startdate||(l||p)>=o.range.enddate)return!1;n=o.range.startdate,r=o.range.enddate,p||(p=l),l||(l=p),i=l<=n?0:(l-n-6e4*(l.getTimezoneOffset()-n.getTimezoneOffset()))/864e5,d=p>=r?(r-n-6e4*(r.getTimezoneOffset()-n.getTimezoneOffset()))/864e5:(p-n-6e4*(p.getTimezoneOffset()-n.getTimezoneOffset()))/864e5;for(var s,c=Math.floor(i),u=c-1;a&&u>=0;){var f=Math.floor(u/7),m=Math.floor(u%7),g=!1;if(s=t.rows[f][m].events)for(var _=s.length-1;_>=0;_--)if((e.id||e.reference)==(s[_].id||s[_].reference)){s.splice(_,1),g=!0;break}if(!g)break;u-=1}for(var h=!0;h||c<d;){h=!1;f=Math.floor(c/7),m=Math.floor(c%7);if(s=t.rows[f][m].events){g=!1;if(a)for(var _ of s)if((e.id||e.reference)==(_.id||_.reference)){g=!0;break}g||s.push(e)}else(s=[]).push(e),t.rows[f][m].events=s;c+=1}for(;a;){f=Math.floor(c/7),m=Math.floor(c%7);if(f>=t.rows.length||m>=t.rows[f].length)break;g=!1;if(s=t.rows[f][m].events)for(_=s.length-1;_>=0;_--)if((e.id||e.reference)==(s[_].id||s[_].reference)){s.splice(_,1),g=!0;break}if(!g)break;c+=1}return!0}function s(e){var t=new Date(e.getFullYear(),0,1).getDay(),a=new Date(e.getFullYear(),0,(t<=4?5:12)-t),n=new Date(e.getFullYear(),e.getMonth(),e.getDate()+(4-e.getDay()))-a;return 1+Math.round(n/6048e5)}t.showWeeks=o.showWeeks,o.mode={step:{months:1}},t.select=function(e){var a=t.rows,n=e.date,r=e.events;if(a){var d=o.currentCalendarDate,l=d.getMonth(),p=d.getFullYear(),s=n.getMonth(),c=n.getFullYear(),u=0;if(p===c?l!==s&&(u=l<s?1:-1):u=p<c?1:-1,o.currentCalendarDate=n,i&&i.$setViewValue(n),0===u)for(var f=0;f<6;f+=1)for(var m=0;m<7;m+=1){var g=0===o.compare(n,a[f][m].date);a[f][m].selected=g,g&&(t.selectedDate=a[f][m])}else o.refreshView();t.timeSelected&&t.timeSelected({selectedTime:n,events:r})}},o._refreshView=function(){for(var a=o.range.startdate,n=a.getDate(),r=(a.getMonth()+(1!==n?1:0))%12,i=a.getFullYear()+(1!==n&&0===r?1:0),l=function(e,t){var a=new Array(t),n=new Date(e),r=0;for(n.setHours(12);r<t;)a[r++]=new Date(n),n.setDate(n.getDate()+1);return a}(a,42),p=0;p<42;p++)l[p]=angular.extend(d(l[p],o.formatDay),{secondary:l[p].getMonth()!==r});t.labels=new Array(7);for(var c=0;c<7;c++)t.labels[c]=e(l[c].date,o.formatDayHeader);var u=new Date(i,r,1);if(t.$parent.title=e(u,o.formatMonthTitle),t.rows=o.split(l,7),t.showWeeks){t.weekNumbers=[];for(var f=t.rows.length,m=0;m<f;m++)t.weekNumbers.push(s(t.rows[m][3].date))}},o._onDataLoaded=function(){var e,a,n=o.eventSource,r=t.rows,i=[];for(e=0;e<6;e+=1)for(a=0;a<7;a+=1)r[e][a].events=null;for(var d of n)p(d,!1)&&t.grouping&&!i.includes(d[t.grouping])&&i.push(d[t.grouping]);for(e=0;e<6;e+=1)for(a=0;a<7;a+=1)r[e][a].events&&r[e][a].events.sort(l);var s=!1;for(e=0;e<6;e+=1){for(a=0;a<7;a+=1)if(r[e][a].selected){t.selectedDate=r[e][a],s=!0;break}if(s)break}t.grouping?t.groupingdir&&"desc"==t.groupingdir?t.categories=i.sort().reverse():t.categories=i.sort():t.categories=["dummy"]},t.$on("duplicateOperationplan",function(e,a,n){for(var r=0;r<6;r+=1)for(var o=0;o<7;o+=1)if(t.rows[r][o].events){var i=[];for(var e of t.rows[r][o].events)i.push(e),e.reference==a.reference&&i.push(n);t.rows[r][o].events=i}t.selectCard(n)}),t.$on("changeMode",function(e,a){o.changeMode(a),t.editable&&"calendarmonth"==a?t.enableDragDrop(p):t.disableDragDrop()}),o.compare=function(e,t){return new Date(e.getFullYear(),e.getMonth(),e.getDate())-new Date(t.getFullYear(),t.getMonth(),t.getDate())},o._getRange=function(e){var t,a=e.getFullYear(),n=e.getMonth(),r=new Date(a,n,1),o=1-r.getDay(),i=o>0?7-o:-o,d=new Date(r);return i>0&&d.setDate(1-i),(t=new Date(d)).setDate(t.getDate()+42),{startdate:d,enddate:t}},o.refreshView(),t.editable&&"calendarmonth"==t.mode&&t.enableDragDrop(p)}}}]).directive("weekview",["dateFilter",function(e){"use strict";return{restrict:"EA",replace:!0,templateUrl:"/static/operationplandetail/week.html",require:"^calendar",link:function(t,a,n,r){function o(e,a){var n,o,i=e.startdate?new Date(e.startdate):null,d=e.enddate?new Date(e.enddate):null;if((d||i)<=r.range.startdate||(i||d)>=r.range.enddate)return!1;d||(d=i),i||(i=d),n=i<=r.range.startdate?0:(i-r.range.startdate-6e4*(i.getTimezoneOffset()-r.range.startdate.getTimezoneOffset()))/36e5,o=d>=r.range.enddate?(r.range.enddate-r.range.startdate-6e4*(r.range.enddate.getTimezoneOffset()-r.range.startdate.getTimezoneOffset()))/36e5:(d-r.range.startdate-6e4*(d.getTimezoneOffset()-r.range.startdate.getTimezoneOffset()))/36e5;for(var l=Math.floor(n),p=Math.ceil((o-.016)/24),s=Math.floor(l/24),c=s-1;a&&c>=0;){var u=!1,f=t.dates[c].events;if(f)for(var m=f.length-1;m>=0;m--)if((e.id||e.reference)==(f[m].id||f[m].reference)){f.splice(m,1),u=!0;break}if(!u)break;c-=1}do{if(t.dates[s].events){u=!1;if(a)for(var m of t.dates[s].events)if((e.id||e.reference)==(m.id||m.reference)){u=!0;break}u||t.dates[s].events.push(e)}else t.dates[s].events=[e];s+=1}while(s<p);for(;a&&s<7;){u=!1;if(f=t.dates[s].events)for(m=f.length-1;m>=0;m--)if((e.id||e.reference)==(f[m].id||f[m].reference)){f.splice(m,1),u=!0;break}if(!u)break;s+=1}return!0}t.formatWeekViewDayHeader=r.formatWeekViewDayHeader,t.formatHourColumn=r.formatHourColumn,r.mode={step:{days:7}},t.hourParts=r.hourParts,t.select=function(e,a){t.timeSelected&&t.timeSelected({selectedTime:e,events:a})},r._onDataLoaded=function(){for(var e=r.eventSource,a=[],n=0;n<7;n+=1)t.dates[n].events&&(t.dates[n].events=null);for(var i of e)o(i,!1)&&t.grouping&&!a.includes(i[t.grouping])&&a.push(i[t.grouping]);t.grouping?t.groupingdir&&"desc"==t.groupingdir?t.categories=a.sort().reverse():t.categories=a.sort():t.categories=["dummy"]},t.$on("duplicateOperationplan",function(e,a,n){for(var r=0;r<7;r+=1)if(t.dates[r].events){var o=[];for(var e of t.dates[r].events)o.push(e),e.reference==a.reference&&o.push(n);t.dates[r].events=o}t.selectCard(n)}),t.$on("changeMode",function(e,a){r.changeMode(a),t.editable&&"calendarweek"==a?t.enableDragDrop(o):t.disableDragDrop()}),r._refreshView=function(){var a,n;t.dates=function(e,t){var a=new Array(t),n=new Date(e),r=0;for(n.setHours(12);r<t;)a[r++]={date:new Date(n)},n.setDate(n.getDate()+1);return a}(r.range.startdate,7),a=r.formatWeekTitle.indexOf("w"),n=e(r.range.startdate,r.formatWeekTitle),-1!==a&&(n=n.replace("w",function(e){var t=new Date(e);t.setDate(t.getDate()+4-(t.getDay()||7));var a=t.getTime();return t.setMonth(0),t.setDate(1),Math.floor(Math.round((a-t)/864e5)/7)+1}(r.range.startdate))),t.$parent.title=n},r._getRange=function(e){var t=e.getFullYear(),a=e.getMonth(),n=e.getDate(),r=e.getDay();return{startdate:new Date(t,a,n-r),enddate:new Date(t,a,n-r+7)}},r.refreshView(),t.editable&&"calendarweek"==t.mode&&t.enableDragDrop(o)}}}]).directive("dayview",["dateFilter",function(e){"use strict";return{restrict:"EA",replace:!0,templateUrl:"/static/operationplandetail/day.html",require:"^calendar",link:function(t,a,n,r){function o(e,t){}t.formatHourColumn=r.formatHourColumn,r.mode={step:{days:1}},t.hourParts=r.hourParts,t.events=[],t.select=function(e,a){t.timeSelected&&t.timeSelected({selectedTime:e,events:a})},t.$on("duplicateOperationplan",function(e,a,n){var r=[];for(var e of t.events)r.push(e),e.reference==a.reference&&r.push(n);t.events=r,t.selectCard(n)}),t.$on("changeMode",function(e,a){r.changeMode(a),t.editable&&"calendarday"==a?t.enableDragDrop(o):t.disableDragDrop()}),r._onDataLoaded=function(){var e=r.eventSource,a=r.range.startdate,n=r.range.enddate,o=[];for(var i of(t.events=null,e)){var d=i.startdate?new Date(i.startdate):null,l=i.enddate?new Date(i.enddate):null;(l||d)<=a||(d||l)>=n||(t.events?t.events.push(i):t.events=[i],t.grouping&&!o.includes(i[t.grouping])&&o.push(i[t.grouping]))}t.grouping?t.groupingdir&&"desc"==t.groupingdir?t.categories=o.sort().reverse():t.categories=o.sort():t.categories=["dummy"]},r._refreshView=function(){var a=r.range.startdate;t.rows=function(e){for(var a,n=[],r=e.getHours(),o=e.getDate(),i=0;i<24;i+=1)(a=new Date(e.getTime())).setHours(r+i),a.setDate(o),n.push({date:a});return t.dt={date:e},n}(a),t.dates=[a],t.$parent.title=e(a,r.formatDayTitle)},r._getRange=function(e){var t=e.getFullYear(),a=e.getMonth(),n=e.getDate();return{startdate:new Date(t,a,n),enddate:new Date(t,a,n+1)}},r.refreshView(),t.editable&&"calendarday"==t.mode&&t.enableDragDrop(o)}}}]);var operationplandetailapp=angular.module("operationplandetailapp",["ngCookies","gettext","ngWebSocket","frepple.input","frepple.common","calendar"],["$locationProvider",function(e){e.html5Mode({enabled:!0,requireBase:!1})}]);function operationplanCtrl(e,t,a,n){function r(e){if(void 0===e.color||""===e.color)return[void 0,""];var t=parseInt(e.color);if(e.inventory_item||e.leadtime){if(!isNaN(t))return t>=100&&t<999999?["rgba(0,128,0,0.5)",Math.round(e.computed_color)+"%"]:0===t?["rgba(255,0,0,0.5)",Math.round(e.computed_color)+"%"]:999999===t?[void 0,""]:["rgba(255,"+Math.round(t/100*255)+",0,0.5)",Math.round(e.computed_color)+"%"]}else{var a=Math.round(parseInt(e.delay)/8640)/10;if(isNaN(a)&&(a=Math.round(parseInt(e.operationplan__delay)/8640)/10),999===parseInt(e.criticality)||999===parseInt(e.operationplan__criticality))return[void 0,""];if(a<0)return["rgba(0,128,0,0.5)",-a+" "+gettext("days early")];if(0===a)return["rgba(0,128,0,0.5)",gettext("on time")];if(a>0)return t>100||t<0?["rgba(255,0,0,0.5)",a+" "+gettext("days late")]:["rgba(255,"+Math.round(t/100*255)+",0,0.5)",a+" "+gettext("days late")]}return[void 0,""]}function o(a){if(!a){var n=$("#grid").getGridParam("postData");a=n&&n.filters?JSON.parse(n.filters):initialfilter}var o=$("#grid").getGridParam("sortname"),i="";""!==o&&(i="&sidx="+encodeURIComponent(o)+"&sord="+encodeURIComponent($("#grid").getGridParam("sortorder")));var d=(-1!=location.href.indexOf("#")?location.href.substr(0,location.href.indexOf("#")):location.href)+(location.search.length>0?"&format=calendar":"?format=calendar")+"&calendarstart="+moment(e.calendarStart).format("YYYY-MM-DD%20HH:MM:SS")+"&calendarend="+moment(e.calendarEnd).format("YYYY-MM-DD%20HH:MM:SS")+i;t.get(d+"&filters="+encodeURIComponent(JSON.stringify(a))).then(function(t){var a=angular.copy(t.data);for(var n of a.rows)n.type=n.operationplan__type||n.type||default_operationplan_type,n.hasOwnProperty("enddate")&&(n.enddate=new Date(n.enddate)),n.hasOwnProperty("operationplan__enddate")&&(n.operationplan__enddate=new Date(n.operationplan__enddate),n.enddate=n.operationplan__enddate),n.hasOwnProperty("startdate")&&(n.startdate=new Date(n.startdate)),n.hasOwnProperty("operationplan__startdate")&&(n.operationplan__startdate=new Date(n.operationplan__startdate),n.startdate=n.operationplan__startdate),n.hasOwnProperty("quantity")&&(n.quantity=parseFloat(n.quantity)),n.hasOwnProperty("operationplan__quantity")&&(n.operationplan__quantity=parseFloat(n.operationplan__quantity)),n.hasOwnProperty("quantity_completed")&&(n.quantity_completed=parseFloat(n.quantity_completed)),n.hasOwnProperty("operationplan__quantity_completed")&&(n.operationplan__quantity_completed=parseFloat(n.operationplan__quantity_completed)),n.hasOwnProperty("operationplan__status")&&(n.status=n.operationplan__status),n.hasOwnProperty("operationplan__origin")&&(n.origin=n.operationplan__origin),[n.color,n.inventory_status]=r(n);e.calendarevents=a.rows,e.totalevents=a.records},function(e){401==e.status&&location.reload()})}e.operationplan=new a,e.aggregatedopplan=null,e.mode=preferences?preferences.mode:"table",e.detailposition=detailposition,e.operationplans=[],e.kanbanoperationplans={},e.ganttoperationplans={},e.deleted=[],e.kanbancolumns=preferences?preferences.columns:void 0,e.kanbancolumns||(e.kanbancolumns=["proposed","approved","confirmed","completed","closed"]),e.groupBy=preferences?preferences.groupBy:void 0,e.groupBy||("undefined"!=typeof groupBy?e.groupBy=groupBy:e.groupBy="status"),e.groupOperator=preferences?preferences.groupOperator:void 0,e.groupOperator||(e.groupOperator="eq"),e.displayongrid=displayongrid,"function"==typeof e.displayongrid&&e.$watchGroup(["operationplan.id","operationplan.start","operationplan.end","operationplan.quantity","operationplan.status","operationplan.quantity_completed","operationplan.remark","operationplan.loadplans","operationplan.resource"],function(t,a){a[0]===t[0]&&-1!==t[0]&&void 0!==a[0]&&(void 0!==a[1]&&void 0!==t[1]&&a[1]!==t[1]&&("kanban"==e.mode||e.mode.startsWith("calendar")?e.$broadcast("selectedEdited","startdate",a[1],new Date(e.operationplan.start)):e.displayongrid(e.operationplan.id,"startdate",e.operationplan.start)),void 0!==a[2]&&void 0!==t[2]&&a[2]!==t[2]&&("kanban"==e.mode||e.mode.startsWith("calendar")?e.$broadcast("selectedEdited","enddate",a[2],new Date(e.operationplan.end)):e.displayongrid(e.operationplan.id,"enddate",e.operationplan.end)),void 0!==a[3]&&void 0!==t[3]&&a[3]!==t[3]&&("kanban"==e.mode||e.mode.startsWith("calendar")?e.$broadcast("selectedEdited","quantity",a[3],e.operationplan.quantity):e.displayongrid(e.operationplan.id,"quantity",e.operationplan.quantity)),void 0!==a[4]&&void 0!==t[4]&&a[4]!==t[4]&&(actions.hasOwnProperty(e.operationplan.status)?"kanban"==e.mode||e.mode.startsWith("calendar")?e.$broadcast("selectedEdited","status",a[4],e.operationplan.status):e.displayongrid(e.operationplan.id,"status",e.operationplan.status):actions[Object.keys(actions)[0]]()),void 0!==a[5]&&void 0!==t[5]&&a[5]!==t[5]&&("kanban"==e.mode||e.mode.startsWith("calendar")?e.$broadcast("selectedEdited","quantity_completed",a[5],e.operationplan.quantity_completed):e.displayongrid(e.operationplan.id,"quantity_completed",e.operationplan.quantity_completed)),void 0!==a[6]&&void 0!==t[6]&&a[6]!==t[6]&&("kanban"==e.mode||e.mode.startsWith("calendar")?e.$broadcast("selectedEdited","remark",a[6],e.operationplan.remark):e.displayongrid(e.operationplan.id,"remark",e.operationplan.remark))),a[0]=t[0]}),e.processAggregatedInfo=function(t,n){var r=[],o={colmodel:{}},i=0;angular.forEach(n,function(e,t){e.hasOwnProperty("summaryType")&&(r.push([t,e.name,e.summaryType,e.formatter]),o[e.name]=null,o.colmodel[e.name]={type:e.summaryType,label:e.label,formatter:e.formatter})}),angular.forEach(t,function(e){angular.forEach(r,function(t){"sum"===t[2]?"duration"===t[3]?"Invalid Date"!==(i=new moment.duration(e[t[1]]).asSeconds())._d&&(null===o[t[1]]?o[t[1]]=i:o[t[1]]+=i):isNaN(parseFloat(e[t[1]]))||(null===o[t[1]]?o[t[1]]=parseFloat(e[t[1]]):o[t[1]]+=parseFloat(e[t[1]])):"max"===t[2]?-1!==["color","number","currency"].indexOf(t[3])&&""!==e[t[1]]?parseFloat(e[t[1]])&&(null===o[t[1]]?o[t[1]]=parseFloat(e[t[1]]):o[t[1]]=Math.max(o[t[1]],parseFloat(e[t[1]]))):"duration"===t[3]?"Invalid Date"!==(i=new moment.duration(e[t[1]]).asSeconds())._d&&(null===o[t[1]]?o[t[1]]=i:o[t[1]]=Math.max(o[t[1]],i)):"date"===t[3]&&"Invalid Date"!==(i=new moment(e[t[1]],datetimeformat))._d&&(null===o[t[1]]||i.isAfter(o[t[1]]))&&(o[t[1]]=i):"min"===t[2]&&(-1!==["color","number"].indexOf(t[3])&&""!==e[t[1]]?(i=parseFloat(e[t[1]]),isNaN(i)||(null===o[t[1]]?o[t[1]]=i:o[t[1]]=Math.min(o[t[1]],i))):"duration"===t[3]?"Invalid Date"!==(i=new moment.duration(e[t[1]]).asSeconds())._d&&(null===o[t[1]]?o[t[1]]=i:o[t[1]]=Math.min(o[t[1]],i)):"date"===t[3]&&"Invalid Date"!==(i=new moment(e[t[1]],datetimeformat))._d&&(null===o[t[1]]?o[t[1]]=i:o[t[1]]=moment.min(o[t[1]],i)))})}),angular.forEach(r,function(e){"duration"===e[3]&&(o[e[1]]=formatDuration(o[e[1]]))}),e.operationplan=new a,o.start=o.startdate||o.operationplan__startdate,moment.isMoment(o.start)&&(o.start=o.start.toDate()),o.end=o.enddate||o.operationplan__enddate,moment.isMoment(o.end)&&(o.end=o.end.toDate()),o.id=-1,o.count=t.length,o.type=t.length>0?t[0].type:"",o.count||angular.element(document).find("#delete_selected, #copy_selected, #edit_selected").prop("disabled",!0),e.$apply(function(){e.operationplan.extend(o)})},e.$on("updateCard",function(t,a,n,r){e.$apply(function(){e.$broadcast("selectedEdited",a,n,r)})}),e.zoom=function(){e.$apply(function(){e.$broadcast("zoom")})},e.displayInfo=function(t){if("kanban"!=e.mode||void 0!==t)if("gantt"!=e.mode||void 0!==t)if(e.mode.startsWith("calendar")&&void 0===t)e.loadCalendarData();else{var n=void 0;void 0!==t&&(n=t.hasOwnProperty("operationplan__reference")?t.operationplan__reference:t.reference),angular.element(document).find("#delete_selected, #copy_selected, #edit_selected").prop("disabled",!1),t&&t.hasOwnProperty("duplicated")?(e.operationplan=new a(t),e.operationplan.id=t.duplicated,e.operationplan.get(r)):(null!==e.operationplan&&"object"==typeof e.operationplan||(e.operationplan=new a),e.operationplan.id=n,void 0===e.operationplan.id?e.$apply(function(){angular.element(document).find("#delete_selected, #copy_selected, #edit_selected").prop("disabled",!0),e.operationplan=new a}):e.operationplan.get(r))}else e.loadGanttData();else e.loadKanbanData();function r(a){if(void 0===t)return a;a.hasOwnProperty("duplicated")&&(a.reference=a.id="Copy of "+a.duplicated,delete a.upstreamoperationplans,delete a.downstreamoperationplans,delete a.pegging_demand),void 0!==t.operationplan__startdate&&""!==t.operationplan__startdate?a.start=t.operationplan__startdate:void 0!==t.startdate&&""!==t.startdate&&(a.start=t.startdate),void 0!==t.operationplan__enddate&&""!==t.operationplan__enddate?a.end=t.operationplan__enddate:void 0!==t.enddate&&""!==t.enddate&&(a.end=t.enddate),void 0!==t.operationplan__quantity&&""!==t.operationplan__quantity?a.quantity=parseFloat(t.operationplan__quantity):void 0!==t.quantity&&""!==t.quantity&&(a.quantity=parseFloat(t.quantity)),void 0!==t.operationplan__status&&""!==t.operationplan__status?a.status=t.operationplan__status:void 0!==t.status&&""!==t.status&&(a.status=t.status),void 0!==t.operationplan__quantity_completed&&""!==t.operationplan__quantity_completed?a.quantity_completed=parseFloat(t.operationplan__quantity_completed):void 0!==t.quantity_completed&&""!==t.quantity_completed&&(a.quantity_completed=parseFloat(t.quantity_completed)),void 0!==a.invstatus&&(a.invstatus.pipeline=0),!e.operationplan.hasOwnProperty("start")||e.operationplan.start instanceof Date||(e.operationplan.start=moment(e.operationplan.start,datetimeformat).toDate()),!e.operationplan.hasOwnProperty("end")||e.operationplan.end instanceof Date||(e.operationplan.end=moment(e.operationplan.end,datetimeformat).toDate()),!e.operationplan.hasOwnProperty("operationplan__startdate")||e.operationplan.operationplan__startdate instanceof Date||(e.operationplan.operationplan__startdate=moment(e.operationplan.operationplan__startdate,datetimeformat).toDate()),!e.operationplan.hasOwnProperty("operationplan__enddate")||e.operationplan.operationplan__enddate instanceof Date||(e.operationplan.operationplan__enddate=moment(e.operationplan.operationplan__enddate,datetimeformat).toDate())}},e.refreshstatus=function(t){"no_action"!==t&&e.$apply(function(){e.operationplan.status=t})},e.toggleShowTop=function(e){showTop=!showTop,n.save("showTop",showTop,function(){location.reload()})},e.toggleShowChildren=function(e){showChildren=!showChildren,n.save("showChildren",showChildren,function(){location.reload()})},e.setMode=function(t){function a(){n.save("mode",t),e.$apply(function(){e.operationplan=null,e.mode=t}),"gantt"==t?$("#zoomin, #zoomout").removeClass("d-none"):$("#zoomin, #zoomout").addClass("d-none"),angular.element("#controller").scope().$broadcast("changeMode",t),"kanban"==t?($("#gridmode, #calendarmode, #ganttmode").removeClass("active"),$("#kanbanmode").addClass("active"),mode="kanban",e.loadKanbanData()):"gantt"==t?($("#gridmode, #calendarmode, #kanbanmode").removeClass("active"),$("#ganttmode").addClass("active"),mode="gantt",e.loadGanttData()):t.startsWith("calendar")?($("#kanbanmode, #gridmode, #ganttmode").removeClass("active"),$("#calendarmode").addClass("active"),mode=t):($("#kanbanmode, #calendarmode, #ganttmode").removeClass("active"),$("#gridmode").addClass("active"),mode="grid",angular.element(document).find("#grid").jqGrid("GridUnload"),initialfilter=thefilter,displayGrid(!0)),setHeights()}var r=angular.element(document).find("#save");return e.mode!=t&&r.hasClass("btn-danger")?($("#popup").html('<div class="modal-dialog"><div class="modal-content"><div class="modal-header alert-warning" style="border-top-left-radius: inherit; border-top-right-radius: inherit"><h5 class="modal-title">'+gettext("Save or cancel your changes first")+'</h5></div><div class="modal-body">'+gettext("There are unsaved changes on this page.")+'</div><div class="modal-footer justify-content-between"><input type="submit" id="cancelbutton" role="button" class="btn btn-primary" data-bs-dismiss="modal" value="'+gettext("Return to page")+'"><input type="submit" id="savebutton" role="button" class="btn btn-danger" value="'+gettext("Save")+'"></div></div></div>'),showModal("popup"),$("#savebutton").on("click",function(){r.trigger("click"),a(),hideModal("popup")}),$("#cancelbutton").on("click",function(){hideModal("popup")}),!1):(a(),!0)},e.displayonpanel=function(t,a,n){angular.element(document.getElementById(e.operationplan.id)).removeClass("edited").addClass("edited"),void 0!==e.operationplan.id&&t===e.operationplan.id.toString()&&("startdate"!==a&&"operationplan__startdate"!==a||e.$apply(function(){e.operationplan.start=n instanceof Date?n:new Date(n)}),"enddate"!==a&&"operationplan__enddate"!==a||e.$apply(function(){e.operationplan.end=n instanceof Date?n:new Date(n)}),"quantity"===a&&e.$apply(function(){e.operationplan.quantity=parseFloat(n)}),"status"===a&&e.refreshstatus(n),"quantity_completed"===a&&e.$apply(function(){e.operationplan.quantity_completed=parseFloat(n)}))},e.calendarevents=[],e.calendarStart=null,e.calendarEnd=null,e.mode=preferences&&preferences.mode||"table",e.calendarRangeChanged=function(t,a){e.calendarStart=t,e.calendarEnd=a,e.mode&&e.mode.startsWith("calendar")&&o()},e.loadCalendarData=o,e.loadKanbanData=function(a){if(!a){var n=$("#grid").getGridParam("postData");a=n&&n.filters?JSON.parse(n.filters):initialfilter}var o=$("#grid").getGridParam("sortname"),i="";""!==o&&(i="&sidx="+encodeURIComponent(o)+"&sord="+encodeURIComponent($("#grid").getGridParam("sortorder")));var d=(-1!=location.href.indexOf("#")?location.href.substr(0,location.href.indexOf("#")):location.href)+(location.search.length>0?"&format=kanban":"?format=kanban");angular.forEach(e.kanbancolumns,function(n){var o=angular.copy(a),l={field:e.groupBy,op:e.groupOperator,data:n};void 0===o||null===o?o={groupOp:"AND",rules:[l],groups:[]}:"AND"==o.groupOp?o.rules.push(l):o={groupOp:"AND",rules:[l],groups:[o]},t.get(d+"&filters="+encodeURIComponent(JSON.stringify(o))+i).then(function(t){var a=angular.copy(t.data);for(var o of a.rows)o.type=o.operationplan__type||o.type||default_operationplan_type,o.hasOwnProperty("enddate")&&(o.enddate=new Date(o.enddate)),o.hasOwnProperty("operationplan__enddate")&&(o.operationplan__enddate=new Date(o.operationplan__enddate)),o.hasOwnProperty("startdate")&&(o.startdate=new Date(o.startdate)),o.hasOwnProperty("operationplan__startdate")&&(o.operationplan__startdate=new Date(o.operationplan__startdate)),o.hasOwnProperty("quantity")&&(o.quantity=parseFloat(o.quantity)),o.hasOwnProperty("operationplan__quantity")&&(o.operationplan__quantity=parseFloat(o.operationplan__quantity)),o.hasOwnProperty("quantity_completed")&&(o.quantity_completed=parseFloat(o.quantity_completed)),o.hasOwnProperty("operationplan__quantity_completed")&&(o.operationplan__quantity_completed=parseFloat(o.operationplan__quantity_completed)),o.hasOwnProperty("operationplan__status")&&(o.status=o.operationplan__status),o.hasOwnProperty("operationplan__origin")&&(o.origin=o.operationplan__origin),[o.color,o.inventory_status]=r(o);e.kanbanoperationplans[n]=a},function(e){401==e.status&&location.reload()})})},e.loadGanttData=function(){var a=$("#grid").getGridParam("postData");thefilter=a&&a.filters?JSON.parse(a.filters):initialfilter;var n=$("#grid").getGridParam("sortname"),o="";""!==n&&(o="&sidx="+encodeURIComponent(n)+"&sord="+encodeURIComponent($("#grid").getGridParam("sortorder")));var i=(-1!=location.href.indexOf("#")?location.href.substr(0,location.href.indexOf("#")):location.href)+(location.search.length>0?"&format=gantt":"?format=gantt")+o;t.get(thefilter?i+"&filters="+encodeURIComponent(JSON.stringify(thefilter)):i).then(function(t){var a=angular.copy(t.data);for(var n of a.rows)n.type=n.operationplan__type||n.type||default_operationplan_type,n.hasOwnProperty("enddate")&&(n.enddate=new Date(n.enddate)),n.hasOwnProperty("operationplan__enddate")&&(n.operationplan__enddate=new Date(n.operationplan__enddate),n.enddate=n.operationplan__enddate),n.hasOwnProperty("startdate")&&(n.startdate=new Date(n.startdate)),n.hasOwnProperty("operationplan__startdate")&&(n.operationplan__startdate=new Date(n.operationplan__startdate),n.startdate=n.operationplan__startdate),n.hasOwnProperty("quantity")&&(n.quantity=parseFloat(n.quantity)),n.hasOwnProperty("operationplan__quantity")&&(n.operationplan__quantity=parseFloat(n.operationplan__quantity)),n.hasOwnProperty("quantity_completed")&&(n.quantity_completed=parseFloat(n.quantity_completed)),n.hasOwnProperty("operationplan__quantity_completed")&&(n.operationplan__quantity_completed=parseFloat(n.operationplan__quantity_completed)),n.hasOwnProperty("operationplan__status")&&(n.status=n.operationplan__status),n.hasOwnProperty("operationplan__origin")&&(n.origin=n.operationplan__origin),[n.color,n.inventory_status]=r(n);e.ganttoperationplans=a},function(e){401==e.status&&location.reload()})},e.getDirtyCards=function(){var t=[];return e.mode&&e.mode.startsWith("calendar")?angular.forEach(e.calendarevents,function(e){var a={id:e.id||e.reference},n=!1;if(e.duplicated){var r={quantity:e.quantity,startdate:new moment(e.operationplan__startdate||e.startdate).format("YYYY-MM-DD HH:mm:ss"),enddate:new moment(e.operationplan__enddate||e.enddate).format("YYYY-MM-DD HH:mm:ss"),status:e.status,type:e.type};"PO"==e.type?(r.supplier=e.operationplan__supplier__name||e.supplier,r.location=e.operationplan__location__name||e.location,r.item=e.operationplan__item__name||e.item):"DO"==e.type?(r.origin=e.operationplan__origin__name||e.origin,r.destination=e.operationplan__destination__name||e.destination,r.item=e.operationplan__item__name||e.item):"MO"==e.type&&(r.operation=e.operationplan__operation__name||e.operation),e.resource&&(r.resource=e.resource),t.push(r)}else{for(var o in e.hasOwnProperty("operationplan__reference")&&(a.operationplan__reference=e.operationplan__reference),e)e.hasOwnProperty(o+"Original")&&(n=!0,e[o]instanceof Date?a[o]=new moment(e[o]).format("YYYY-MM-DD HH:mm:ss"):a[o]=e[o]);n&&t.push(a)}}):"kanban"==e.mode&&angular.forEach(e.kanbanoperationplans,function(e,a){angular.forEach(e.rows,function(e){var a={id:e.id||e.reference},n=!1;if(e.duplicated){var r={quantity:e.quantity,startdate:new moment(e.operationplan__startdate||e.startdate).format("YYYY-MM-DD HH:mm:ss"),enddate:new moment(e.operationplan__enddate||e.enddate).format("YYYY-MM-DD HH:mm:ss"),status:e.operationplan__status||e.status,type:e.type};"PO"==e.type?(r.supplier=e.operationplan__supplier||e.supplier,r.location=e.operationplan__location||e.location,r.item=e.operationplan__item||e.item):"DO"==e.type?(r.origin=e.operationplan__origin||e.origin,r.destination=e.operationplan__destination||e.destination,r.item=e.operationplan__item||e.item):"MO"==e.type&&(r.operation=e.operationplan__operation__name||e.operation,console.log("dddd",r)),t.push(r)}for(var o in e.hasOwnProperty("operationplan__reference")&&(a.operationplan__reference=e.operationplan__reference),e)e.hasOwnProperty(o+"Original")&&(n=!0,e[o]instanceof Date?a[o]=new moment(e[o]).format("YYYY-MM-DD HH:mm:ss"):a[o]=e[o]);n&&t.push(a)})}),e.deleted&&e.deleted.length&&(t.push({delete:e.deleted}),e.deleted=[]),t!=[]&&(e.operationplan=void 0),t},e.duplicateOperationPlan=function(){var t=[];e.mode&&e.mode.startsWith("calendar")?(e.$apply(function(){for(var a of(angular.forEach(e.calendarevents,function(a){if(e.operationplan.id==a.operationplan__reference||e.operationplan.id==a.reference){var n=angular.copy(a);a.operationplan__reference&&(n.hasOwnProperty("duplicated")||(n.duplicated=a.operationplan__reference),n.operationplan__reference=a.operationplan__reference&&a.operationplan__reference.startsWith("Copy of")?a.operationplan__reference:"Copy of "+a.operationplan__reference),a.id&&(n.hasOwnProperty("duplicated")||(n.duplicated=a.id),n.id=a.id&&a.id.startsWith("Copy of")?a.id:"Copy of "+a.id,n.duplicated=a.duplicated?a.duplicated:a.reference),a.reference&&(n.hasOwnProperty("duplicated")||(n.duplicated=a.reference),n.reference=a.reference&&a.reference.startsWith("Copy of")?a.reference:"Copy of "+a.reference),n.dirty=!0,t.push([a,n]),e.totalevents+=1}}),t))e.calendarevents.push(a[1]),e.$broadcast("duplicateOperationplan",a[0],a[1])}),angular.element(document).find("#save, #undo").removeClass("btn-primary btn-danger").addClass("btn-danger").prop("disabled",!1),$(window).off("beforeunload",upload.warnUnsavedChanges),$(window).on("beforeunload",upload.warnUnsavedChanges)):"kanban"==e.mode&&e.$apply(function(){angular.forEach(e.kanbanoperationplans,function(a){for(var n of(t=[],angular.forEach(a.rows,function(a){if(e.operationplan.id==a.operationplan__reference||e.operationplan.id==a.reference){var n=angular.copy(a);a.operationplan__reference&&(n.hasOwnProperty("duplicated")||(n.duplicated=a.operationplan__reference),n.operationplan__reference=a.operationplan__reference&&a.operationplan__reference.startsWith("Copy of")?a.operationplan__reference:"Copy of "+a.operationplan__reference),a.id&&(n.hasOwnProperty("duplicated")||(n.duplicated=a.id),n.id=a.id&&a.id.startsWith("Copy of")?a.id:"Copy of "+a.id),a.reference&&(n.hasOwnProperty("duplicated")||(n.duplicated=a.reference),n.reference=a.reference&&a.reference.startsWith("Copy of")?a.reference:"Copy of "+a.reference),t.push([a,n]),n.dirty=!0}}),t))a.rows.push(n[1]),e.$broadcast("duplicateOperationplan",n[0],n[1])}),angular.element(document).find("#save, #undo").removeClass("btn-primary btn-danger").addClass("btn-danger").prop("disabled",!1),$(window).off("beforeunload",upload.warnUnsavedChanges),$(window).on("beforeunload",upload.warnUnsavedChanges)})},e.removeOperationPlan=function(){e.operationplan&&e.operationplan.reference&&(e.mode&&e.mode.startsWith("calendar")?(e.$apply(function(){e.calendarevents=e.calendarevents.filter(t=>t.operationplan__reference!=e.operationplan.reference&&t.reference!=e.operationplan.reference),e.deleted.push(e.operationplan.reference),e.operationplan=new a}),angular.element(document).find("#delete_selected, #copy_selected, #edit_selected").prop("disabled",!0),angular.element(document).find("#save, #undo").removeClass("btn-primary btn-danger").addClass("btn-danger").prop("disabled",!1),$(window).off("beforeunload",upload.warnUnsavedChanges),$(window).on("beforeunload",upload.warnUnsavedChanges)):e.mode&&"kanban"==e.mode&&(e.$apply(function(){for(var t in e.kanbanoperationplans)e.kanbanoperationplans[t].rows=e.kanbanoperationplans[t].rows.filter(t=>t.operationplan__reference!=e.operationplan.reference&&t.reference!=e.operationplan.reference);e.deleted.push(e.operationplan.reference),e.operationplan=new a}),angular.element(document).find("#delete_selected, #copy_selected, #edit_selected").prop("disabled",!0),angular.element(document).find("#save, #undo").removeClass("btn-primary btn-danger").addClass("btn-danger").prop("disabled",!1),$(window).off("beforeunload",upload.warnUnsavedChanges),$(window).on("beforeunload",upload.warnUnsavedChanges)))},preferences&&("kanban"==preferences.mode?e.loadKanbanData():"gantt"==preferences.mode&&e.loadGanttData())}function showproblemspanelDrv(e,t){return{restrict:"EA",scope:{operationplan:"=data"},link:function(e,a,n){var r='<div class="card-header"><h5 class="card-title" style="text-transform: capitalize">'+t.getString("problems")+'</h5></div><table class="table table-sm table-hover table-borderless"><thead><tr><td><b style="text-transform: capitalize;">'+t.getString("name")+'</b></td><td><b style="text-transform: capitalize;">'+t.getString("start")+'</b></td><td><b style="text-transform: capitalize;">'+t.getString("end")+"</b></td></tr></thead><tbody></tbody></table>";e.$watchGroup(["operationplan.id","operationplan.problems.length"],function(a,n){angular.element(document).find("#attributes-operationproblems").empty().append(r);var o='<tr><td colspan="3">'+t.getString("no problems")+"</td></tr>";void 0!==e.operationplan&&e.operationplan.hasOwnProperty("problems")&&(o="",angular.forEach(e.operationplan.problems,function(e){o+="<tr><td>"+e.description+"</td><td>"+e.start+"</td><td>"+e.end+"</td></tr>"})),angular.element(document).find("#attributes-operationproblems tbody").append(o)})}}}function showresourcespanelDrv(e,t){return{restrict:"EA",scope:{operationplan:"=data",mode:"=mode"},link:function(e,a,n){var r='<div class="card-header"><h5 class="card-title" style="text-transform: capitalize">'+t.getString("resource")+'</h5></div><div class="card-body"><table class="table table-sm table-hover table-borderless"><thead><tr><td><b style="text-transform: capitalize;">'+t.getString("name")+'</b></td><td><b style="text-transform: capitalize;">'+t.getString("quantity")+"</b></td><tbody></tbody></table></div>";e.$watchGroup(["operationplan.id","operationplan.loadplans.length"],function a(){angular.element(document).find("#attributes-operationresources").empty().append(r);var n='<tr><td colspan="2">'+t.getString("no resources")+"</td></tr>";void 0!==e.operationplan&&e.operationplan.hasOwnProperty("loadplans")&&(n="",angular.forEach(e.operationplan.loadplans,function(e){e.hasOwnProperty("alternates")?(n+='<tr><td style="white-space: nowrap;"><div class="dropdown"><button class="form-control w-auto dropdown-toggle" data-bs-toggle="dropdown" type="button" style="min-width: 150px">'+$.jgrid.htmlEncode(e.resource.name)+'</button><ul class="dropdown-menu"><li><a role="menuitem" class="dropdown-item alternateresource text-capitalize">'+$.jgrid.htmlEncode(e.resource.name)+"</a></li>",angular.forEach(e.alternates,function(e){n+='<li><a role="menuitem" class="dropdown-item alternateresource text-capitalize">'+$.jgrid.htmlEncode(e.name)+"</a></li>"}),n+="</ul></td><td>"+grid.formatNumber(e.quantity)+"</td></tr>"):n+="<tr><td>"+$.jgrid.htmlEncode(e.resource.name)+'<a href="'+url_prefix+"/detail/input/resource/"+admin_escape(e.resource.name)+"/\" onclick='event.stopPropagation()'><span class='ps-2 fa fa-caret-right'></span></a></td><td>"+grid.formatNumber(e.quantity)+"</td></tr>"}));angular.element(document).find("#attributes-operationresources tbody").append(n);angular.element(document).find("#attributes-operationresources a.alternateresource").bind("click",function(){var t=$(this).html(),n=$(this).parent().parent().prev().html();if(t!=n){var r=!0;angular.forEach(e.operationplan.loadplans,function(o){if(o.resource.name==n&&r){if(r=!1,o.resource.name=t,angular.forEach(o.alternates,function(e){e.name===t&&(e.name=n)}),a(),e.mode&&(e.mode.startsWith("calendar")||"kanban"==e.mode))e.$emit("updateCard","loadplans",e.operationplan.loadplansOriginal,e.operationplan.loadplans);else{var i=angular.element(document).find("#grid"),d=i.jqGrid("getGridParam","selarrrow"),l=i.jqGrid("getGridParam","colModel").find(function(e){return"resources"==e.name});l||(l=i.jqGrid("getGridParam","colModel").find(function(e){return"resource"==e.name}));var p=i.jqGrid("getCell",d,l.name);if("detail"==l.formatter&&p==n)i.jqGrid("setCell",d,l.name,t,"dirty-cell"),i.jqGrid("setRowData",d,!1,"edited"),angular.element(document).find("#save").removeClass("btn-primary btn-danger").addClass("btn-danger").prop("disabled",!1),angular.element(document).find("#undo").removeClass("btn-primary btn-danger").addClass("btn-danger").prop("disabled",!1),$(window).off("beforeunload",upload.warnUnsavedChanges),$(window).on("beforeunload",upload.warnUnsavedChanges);else if("listdetail"==l.formatter){var s=[];angular.forEach(e.operationplan.loadplans,function(e){s.push([e.resource.name,e.quantity,e.reference])}),i.jqGrid("setCell",d,l.name,s,"dirty-cell"),i.jqGrid("setRowData",d,!1,"edited"),angular.element(document).find("#save").removeClass("btn-primary btn-danger").addClass("btn-danger").prop("disabled",!1),angular.element(document).find("#undo").removeClass("btn-primary btn-danger").addClass("btn-danger").prop("disabled",!1),$(window).off("beforeunload",upload.warnUnsavedChanges),$(window).on("beforeunload",upload.warnUnsavedChanges)}}return!1}})}})})}}}function showbufferspanelDrv(e,t,a){return{restrict:"EA",scope:{operationplan:"=data"},link:function(e,n,r){var o='<div class="card-header"><h5 class="card-title" style="text-transform: capitalize">'+t.getString("items")+'</h5></div><div class="card-body"><table class="table table-sm table-hover table-borderless"><thead><tr><td><b style="text-transform: capitalize;">'+t.getString("item")+'</b></td><td><b style="text-transform: capitalize;">'+t.getString("quantity")+'</b></td><td><b style="text-transform: capitalize;">'+t.getString("onhand")+'</b></td><td><b style="text-transform: capitalize;">'+t.getString("date")+"</b></td></tr></thead><tbody></tbody></table></div>";e.$watchGroup(["operationplan.id","operationplan.flowplans.length"],function n(){angular.element(document).find("#attributes-operationflowplans").empty().append(o);var r='<tr><td colspan="3">'+t.getString("no movements")+"<td></tr>";if(void 0!==e.operationplan&&e.operationplan.hasOwnProperty("flowplans")){r="";var i=!0;angular.forEach(e.operationplan.flowplans,function(e){e.quantity>0&&i?(r+='<tr class="border-top">',i=!1):r+="<tr>",e.hasOwnProperty("alternates")?(r+='<td style="white-space: nowrap"><div class="dropdown"><button class="btn btn-primary" data-bs-toggle="dropdown" type="button" style="text-transform: capitalize; min-width: 150px">'+$.jgrid.htmlEncode(e.buffer.item)+'</button><ul class="dropdown-menu"><li><a role="menuitem" class="dropdown-item alternateitem" style="text-transform: capitalize">'+$.jgrid.htmlEncode(e.buffer.item)+"</a></li>",angular.forEach(e.alternates,function(e){r+='<li><a role="menuitem" class="dropdown-item alternateitem" style="text-transform: capitalize">'+$.jgrid.htmlEncode(e)+"</a></li>"}),r+="</ul></td>"):(r+="<td><span ",e.buffer.description&&(r+=' onmouseenter="$(this).tooltip(\'show\')" title="'+$.jgrid.htmlEncode(e.buffer.description)+'"'),r+=">"+$.jgrid.htmlEncode(e.buffer.item)+'<a href="'+url_prefix+"/detail/input/item/"+admin_escape(e.buffer.item)+"/\" onclick='event.stopPropagation()'><span class='ps-2 fa fa-caret-right'></span></a></span></td>"),r+="<td>"+grid.formatNumber(e.quantity)+"</td><td>"+grid.formatNumber(e.onhand)+'</td><td style="white-space: nowrap">'+a("formatdatetime")(e.date)+"</td></tr>"}),angular.element(document).find("#attributes-operationflowplans thead").css("display","table-header-group")}angular.element(document).find("#attributes-operationflowplans tbody").append(r);angular.element(document).find("#attributes-operationflowplans a.alternateitem").bind("click",function(){var t=$(this).html(),a=$(this).parent().parent().prev().html();t!=a&&angular.forEach(e.operationplan.flowplans,function(r){if(r.buffer.item==a){r.buffer.item=t,n();var o=angular.element(document).find("#grid"),i=o.jqGrid("getGridParam","selarrrow"),d=o.jqGrid("getGridParam","colModel").find(function(e){return"material"==e.name}),l=o.jqGrid("getCell",i,"material");if("detail"==d.formatter&&l==a)o.jqGrid("setCell",i,"material",t,"dirty-cell"),o.jqGrid("setRowData",i,!1,"edited"),angular.element(document).find("#save").removeClass("btn-primary btn-danger").addClass("btn-danger").prop("disabled",!1),angular.element(document).find("#undo").removeClass("btn-primary btn-danger").addClass("btn-danger").prop("disabled",!1);else if("listdetail"==d.formatter){var p=[];angular.forEach(e.operationplan.flowplans,function(e){p.push([e.buffer.item,e.quantity])}),o.jqGrid("setCell",i,"material",p,"dirty-cell"),o.jqGrid("setRowData",i,!1,"edited"),angular.element(document).find("#save").removeClass("btn-primary btn-danger").addClass("btn-danger").prop("disabled",!1),angular.element(document).find("#undo").removeClass("btn-primary btn-danger").addClass("btn-danger").prop("disabled",!1)}return!1}})})})}}}function showoperationpeggingpanelDrv(e,t,a){return{restrict:"EA",scope:{operationplan:"=data"},link:function(e,n,r,o){var i='<div class="card-header"><h5 class="card-title" style="text-transform: capitalize">'+t.getString("demand")+'</h5></div><div class="card-body table-responsive" style="max-height:15em; overflow:auto"><table class="table table-sm table-hover table-borderless"><thead><tr><td><b style="text-transform: capitalize;">'+t.getString("name")+'</b></td><td><b style="text-transform: capitalize;">'+t.getString("item")+'</b></td><td><b style="text-transform: capitalize;">'+t.getString("due")+'</b></td><td><b style="text-transform: capitalize;">'+t.getString("quantity")+"</b></td><tbody></tbody></table></div>";e.$watchGroup(["operationplan.id","operationplan.pegging_demand.length"],function(n,r){angular.element(document).find("#attributes-operationdemandpegging").empty().append(i);var o='<tr><td colspan="2">'+t.getString("no demands")+"</td></tr>";void 0!==e.operationplan&&e.operationplan.hasOwnProperty("pegging_demand")&&(o="",angular.forEach(e.operationplan.pegging_demand,function(e){o+="<tr><td>"+$.jgrid.htmlEncode(e.demand.name)+'<a href="'+url_prefix+(e.demand.forecast?"/detail/forecast/forecast/":"/detail/input/demand/")+admin_escape(e.demand.name)+"/\" onclick='event.stopPropagation()'><span class='ps-2 fa fa-caret-right'></span></a></td><td>",e.demand.item.description?o+='<span onmouseenter="$(this).tooltip(\'show\')" title="'+$.jgrid.htmlEncode(e.demand.item.description)+'">'+$.jgrid.htmlEncode(e.demand.item.name)+"</span>":o+=$.jgrid.htmlEncode(e.demand.item.name),o+='<a href="'+url_prefix+"/detail/input/item/"+admin_escape(e.demand.item.name)+"/\" onclick='event.stopPropagation()'><span class='ps-2 fa fa-caret-right'></span></a></td><td>"+a("formatdate")(e.demand.due)+"</td><td>"+grid.formatNumber(e.quantity)+"</td></tr>"})),angular.element(document).find("#attributes-operationdemandpegging tbody").append(o)})}}}function showoperationplanDrv(e,t){return{restrict:"EA",scope:!0,templateUrl:"/static/operationplandetail/operationplanpanel.html",link:function(e,a,n){e.actions=actions,e.editable=editable,e.opptype={MO:t.getString("manufacturing order"),PO:t.getString("purchase order"),DO:t.getString("distribution order"),STCK:t.getString("stock"),DLVR:t.getString("delivery")},e.$on("cardChanged",function(t,a,n,r){e.operationplan&&("startdate"===a?e.operationplan.start=r:"enddate"===a?e.operationplan.end=r:e.operationplan[a]=r)}),e.$watchGroup(["operationplan.id","operationplan.start","operationplan.end","operationplan.quantity","operationplan.completed_quantity","operationplan.criticality","operationplan.delay","operationplan.status","operationplan.remark"],function(t,n){void 0!==e.operationplan&&null!==e.operationplan&&(-1==e.operationplan.id||"STCK"===e.operationplan.type?angular.element(a).find("input").attr("disabled","disabled"):void 0!==e.operationplan.id?(angular.element(a).find("input[disabled]").attr("disabled",!1),e.operationplan.hasOwnProperty("start")&&angular.element(a).find("#setStart").val(moment.utc(e.operationplan.start,datetimeformat).format(datetimeformat)),e.operationplan.hasOwnProperty("end")&&angular.element(a).find("#setEnd").val(moment.utc(e.operationplan.end,datetimeformat).format(datetimeformat))):(angular.element(a).find("#setStart").val(""),angular.element(a).find("#setEnd").val("")),angular.element(a).find("#statusrow").css("display",e.operationplan.status&&"STCK"!==e.operationplan.type?"table-row":"none"))})}}}function showsupplyinformationDrv(e,t){return{restrict:"EA",scope:{operationplan:"=data"},link:function(e,a,n){var r='<div class="card-header"><h5 class="card-title" style="text-transform: capitalize">'+t.getString("supply information")+'</h5></div><div class="table-responsive"><table class="table table-hover table-sm"><thead><tr><td><b style="text-transform: capitalize;">'+t.getString("priority")+'</b></td><td><b style="text-transform: capitalize;">'+t.getString("types")+'</b></td><td><b style="text-transform: capitalize;">'+t.getString("origin")+'</b></td><td><b style="text-transform: capitalize;">'+t.getString("lead time")+'</b></td><td><b style="text-transform: capitalize;">'+t.getString("cost")+'</b></td><td><b style="text-transform: capitalize;">'+t.getString("size minimum")+'</b></td><td><b style="text-transform: capitalize;">'+t.getString("size multiple")+'</b></td><td><b style="text-transform: capitalize;">'+t.getString("effective start")+'</b></td><td><b style="text-transform: capitalize;">'+t.getString("effective end")+"</b></td></tr></thead><tbody></tbody></table></div>";e.$watchGroup(["operationplan.id","operationplan.attributes.supply.length"],function(a,n){angular.element(document).find("#attributes-supplyinformation").empty().append(r);var o='<tr><td colspan="9">'+t.getString("no supply information")+"</td></tr>";void 0!==e.operationplan&&e.operationplan.attributes.hasOwnProperty("supply")&&(o="",angular.forEach(e.operationplan.attributes.supply,function(e){for(var t in o+="<tr>",e)o+="<td>",o+=e[t],o+="</td>";o+="</tr>"})),angular.element(document).find("#attributes-supplyinformation tbody").append(o)})}}}function showdownstreamoperationplansDrv(e,t){return{restrict:"EA",scope:{operationplan:"=data"},templateUrl:"/static/operationplandetail/downstreamoperationplans.html",link:function(e,t,a){e.expandOrCollapse=function(t){var a=t+1,n=e.operationplan.downstreamoperationplans[t][0];0==e.operationplan.downstreamoperationplans[t][11]?e.operationplan.downstreamoperationplans[t][11]=1:e.operationplan.downstreamoperationplans[t][11]=0;for(;a<e.operationplan.downstreamoperationplans.length&&!(e.operationplan.downstreamoperationplans[a][0]<=n);)e.operationplan.downstreamoperationplans[a][0]>n+1||0==e.operationplan.downstreamoperationplans[t][11]?e.operationplan.downstreamoperationplans[a][11]=2:a==e.operationplan.downstreamoperationplans.length-1||e.operationplan.downstreamoperationplans[a][0]>=e.operationplan.downstreamoperationplans[a+1][0]?null!=e.operationplan.downstreamoperationplans[a][12]&&e.operationplan.downstreamoperationplans[a][12]==e.operationplan.downstreamoperationplans[a+1][12]?e.operationplan.downstreamoperationplans[a][11]=1:e.operationplan.downstreamoperationplans[a][11]=3:e.operationplan.downstreamoperationplans[a][0]==n+1&&1==e.operationplan.downstreamoperationplans[t][11]&&(e.operationplan.downstreamoperationplans[a][11]=0),++a},e.url_prefix=url_prefix}}}function showupstreamoperationplansDrv(e,t){return{restrict:"EA",scope:{operationplan:"=data"},templateUrl:"/static/operationplandetail/upstreamoperationplans.html",link:function(e,t,a){e.expandOrCollapse=function(t){var a=t+1,n=e.operationplan.upstreamoperationplans[t][0];0==e.operationplan.upstreamoperationplans[t][11]?e.operationplan.upstreamoperationplans[t][11]=1:e.operationplan.upstreamoperationplans[t][11]=0;for(;a<e.operationplan.upstreamoperationplans.length&&!(e.operationplan.upstreamoperationplans[a][0]<=n);)e.operationplan.upstreamoperationplans[a][0]>n+1||0==e.operationplan.upstreamoperationplans[t][11]?e.operationplan.upstreamoperationplans[a][11]=2:a==e.operationplan.upstreamoperationplans.length-1||e.operationplan.upstreamoperationplans[a][0]>=e.operationplan.upstreamoperationplans[a+1][0]?null!=e.operationplan.upstreamoperationplans[a][12]&&e.operationplan.upstreamoperationplans[a][12]==e.operationplan.upstreamoperationplans[a+1][12]?e.operationplan.upstreamoperationplans[a][11]=1:e.operationplan.upstreamoperationplans[a][11]=3:e.operationplan.upstreamoperationplans[a][0]==n+1&&1==e.operationplan.upstreamoperationplans[t][11]&&(e.operationplan.upstreamoperationplans[a][11]=0),++a},e.url_prefix=url_prefix}}}function showKanbanDrv(e,t,a,n){"use strict";return{restrict:"EA",scope:{operationplan:"=",kanbanoperationplans:"=",kanbancolumns:"=",editable:"="},templateUrl:"/static/operationplandetail/kanban.html",link:function(e,a,r){function o(e){e.preventDefault()}function i(t){var a=$(t.target).closest("div[data-column]").attr("data-column");if(a){var r=t.originalEvent.dataTransfer.getData("startcolumn"),o=t.originalEvent.dataTransfer.getData("startindex");if("undefined"!==o){var i=$(t.target).closest(".card");i&&(i=i.attr("data-index")),e.$apply(function(){var t=e.kanbanoperationplans[r].rows[o];e.kanbanoperationplans[r].rows.splice(o,1),i?e.kanbanoperationplans[a].rows.splice(i>o&&a==r?i-1:i,0,t):e.kanbanoperationplans[a].rows.unshift(t),e.kanbanoperationplans[r].records--,e.kanbanoperationplans[a].records++,angular.element(document).find("#save, #undo").removeClass("btn-primary btn-danger").addClass("btn-danger").prop("disabled",!1),$(window).off("beforeunload",upload.warnUnsavedChanges),$(window).on("beforeunload",upload.warnUnsavedChanges),t.hasOwnProperty("operationplan__status")?t.hasOwnProperty("operationplan__statusOriginal")?(t.operationplan__statusOriginal==a?(t.dirty=!1,delete t.operationplan__statusOriginal):t.dirty=!0,t.operationplan__status=a,t.status=envalue):t.operationplan__status!=a&&(t.operationplan__statusOriginal=t.operationplan__status,t.operationplan__status=a,t.status=a,t.dirty=!0):t.hasOwnProperty("statusOriginal")?(t.statusOriginal==a?(t.dirty=!1,delete t.statusOriginal):t.dirty=!0,t.status=a):t.status!=a&&(t.statusOriginal=t.status,t.status=a,t.dirty=!0),e.$parent.$broadcast("cardChanged","status",t.statusOriginal,t.status)})}else e.$apply(function(){var t=e.kanbancolumns.indexOf(r),o=e.kanbancolumns.indexOf(a),i=e.kanbancolumns[t];e.kanbancolumns[t]=e.kanbancolumns[o],e.kanbancolumns[o]=i,n.save("columns",e.$parent.kanbancolumns)})}t.preventDefault()}function d(e){e.originalEvent.dataTransfer.setData("startindex",$(e.target).attr("data-index")),e.originalEvent.dataTransfer.setData("startcolumn",$(e.target).closest("div[data-column]").attr("data-column")),e.stopPropagation()}function l(){a.on("dragover","div[data-column], .card",o),a.on("drop","div[data-column]",i),a.on("dragstart","div[data-column] .panel .card-header, .card",d)}function p(){a.off("dragover","div[data-column], .card",o),a.off("drop","div[data-column]",i),a.off("dragstart","div[data-column] .panel .card-header, .card",d)}e.curselected=null,e.colstyle="col-md-1",e.type="PO",e.admin_escape=admin_escape,e.url_prefix=url_prefix,e.mode=mode,e.opptype={MO:t.getString("Manufacturing Order"),PO:t.getString("Purchase Order"),DO:t.getString("Distribution Order"),STCK:t.getString("Stock"),DLVR:t.getString("Delivery")},e.getHeight=function(e){return preferences&&preferences.height?preferences.height-(e||25):220},e.hideColumn=function(t){var a=e.$parent.kanbancolumns.indexOf(t);e.$parent.kanbancolumns.splice(a,1),n.save("columns",e.$parent.kanbancolumns)},e.grid=grid,e.selectCard=function(t){if(e.curselected){if(e.curselected.reference&&e.curselected.reference==t.reference&&t.selected)return;if(e.curselected.operationplan__reference&&e.curselected.operationplan__reference==t.reference&&t.selected)return;delete e.curselected.selected}t.selected=!0,e.curselected=t,e.$parent.displayInfo(t),angular.element(document).find("#delete_selected, #gridactions").prop("disabled",!1)},e.$on("selectedEdited",function(t,a,n,r){if(null!==e.curselected){if("loadplans"==a){var o=[];angular.forEach(r,function(e){o.push([e.resource.name,e.quantity])}),e.changeCard(e.curselected,"resource",e.curselected.resource,o),e.curselected.resource=o}else e.changeCard(e.curselected,a,n,r);if("status"===a){var i=e.kanbanoperationplans[n].rows.indexOf(e.curselected);-1!=i&&(e.kanbanoperationplans[n].rows.splice(i,1),e.kanbanoperationplans[r].rows.unshift(e.curselected),e.kanbanoperationplans[n].records--,e.kanbanoperationplans[r].records++)}"loadplans"!=a&&(e.curselected.hasOwnProperty("operationplan__"+a)?e.curselected["operationplan__"+a]=r:e.curselected[a]=r)}}),e.changeCard=function(t,a,n,r){t.hasOwnProperty(a+"Original")||(t[a+"Original"]=n),t.dirty=!0,angular.element(document).find("#save, #undo").removeClass("btn-primary btn-danger").addClass("btn-danger").prop("disabled",!1),$(window).off("beforeunload",upload.warnUnsavedChanges),$(window).on("beforeunload",upload.warnUnsavedChanges),void 0!==r&&e.$parent.$broadcast("cardChanged",a,n,r)},e.enableDragDrop=l,e.disableDragDrop=p,e.$on("duplicateOperationplan",function(t,a,n){e.selectCard(n)}),e.$on("changeMode",function(t,a){e.mode=a,e.editable&&"kanban"==a?l():p()}),e.editable&&"kanban"==mode&&l()}}}function showGanttDrv(e,t,a,n){"use strict";return{restrict:"EA",scope:{ganttoperationplans:"=",editable:"="},templateUrl:"/static/operationplandetail/gantt.html",link:function(e,t,a){function n(t){if(t.operationplan__reference===e.curselected)return"black";var a=parseInt(t.operationplan__color);if(t.operationplan__inventory_item||t.operationplan__leadtime){if(!isNaN(a))return a>=100&&a<999999?"#008000":0===a?"#f00":999999===a?"white":"rgb(255,"+(a=Math.round(a/100*255))+",0)"}else{var n=Math.round(parseInt(t.operationplan__delay)/8640)/10;if(999===parseInt(t.operationplan__criticality))return"#f00";if(n<0)return"#008000";if(0===n)return"#008000";if(n>0)return a>100||a<0?"#f00":"rgb(255,"+Math.round(a/100*255)+",0)"}return"rgb(111,111,255)"}function r(e){return Math.round(1e4*(e-viewstart)/(viewend-viewstart))}function o(e){return Math.round(1e4*e/(viewend-viewstart))}function i(){var t=$("#ganttgraph").width(),a=(t-200)/1e4;if(e.ganttoperationplans.rows){var i,d='<table class="table" style="table-layout: fixed"><tr><th class="align-middle" style="width:200px">'+gettext("resource")+'</th><th style="overflow-x: scroll; width:'+t+'px" id="ganttheader"></th></tr>',l=!0,p=[],s="";for(var c of e.ganttoperationplans.rows){c.resource!=i&&(i=c.resource,l||(d+='<svg width="100%" height="'+p.length*e.rowheight+'px"><g class="ganttrow" transform="scale('+a+",1) translate(0,"+(p.length-1)*e.rowheight+')" title="'+p.length+'">'+s+"</g></svg></td></tr>"),l=!1,d+="<tr><td>"+c.resource+'</td><td style="width: '+t+'px">',p=[],s="");for(var u=0;u<p.length;++u)if(new Date(c.startdate)>=p[u]&&c.enddate!=c.startdate){p[u]=new Date(c.enddate);break}u>=p.length&&p.push(new Date(c.enddate)),s+='<rect class="opplan" x="'+r(new Date(c.startdate))+'" y="'+-u*e.rowheight+'" fill="'+n(c)+'" width="'+o(c.enddate-c.startdate)+'" height="'+e.rowheight+'" data-reference="'+encodeURI(c.operationplan__reference)+'"',"proposed"==c.status?s+=' fill-opacity="0.5"/>':s+="/>"}l||(d+='<svg width = "100%" height = "'+p.length*e.rowheight+'px"><g class="ganttrow" transform="scale('+a+",1) translate(0,"+(p.length-1)*e.rowheight+')" title="'+p.length+'">'+s+"</g></svg></td></tr>"),d+="</table>",angular.element(document).find("#ganttgraph").empty().append(d),gantt.header("#ganttheader"),$("svg rect").on("click",function(t){var a=e.findOperationPlan(e.curselected);a&&(e.curselected=null,$('svg rect[data-reference="'+admin_escape(a.operationplan__reference)+'"]').attr("fill",e.buildcolor(a)).attr("fill-opacity","proposed"==a.operationplan__status?"0.5":"1"));var n=$(t.target).attr("data-reference"),r=e.findOperationPlan(n);r&&($(t.target).attr("fill","black").attr("fill-opacity","1"),r.id=n),e.curselected=r?r.operationplan__reference:null,e.$parent.displayInfo(r)}).each(function(){bootstrap.Tooltip.getOrCreateInstance($(this)[0],{title:e.buildtooltip,animation:!1,html:!0,container:"body",trigger:"hover",template:'<div class="tooltip opacity-100" role="tooltip">\n                <div class="tooltip-arrow"></div>\n                <div class="tooltip-inner bg-white text-start text-body fs-6 p-3"></div>\n              </div>'})})}}e.rowheight=25,e.curselected=null,e.colstyle="col-md-1",e.type="PO",e.admin_escape=admin_escape,e.url_prefix=url_prefix,e.mode=mode,e.$watch("ganttoperationplans",function(){e.drawGantt()}),e.getHeight=function(e){return preferences&&preferences.height?preferences.height-(e||25):220},e.getDirtyCards=function(){return console.log("getting changes"),111},e.findOperationPlan=function(t){return null===t?null:e.ganttoperationplans.rows?e.ganttoperationplans.rows.find(e=>e.operationplan__reference==t):null},e.buildtooltip=function(){var t=e.findOperationPlan($(this).attr("data-reference")),a="",n=Math.round(t.operationplan__delay/8640)/10;n=n<.1?-n+" "+gettext("days early"):n>.1?n+" "+gettext("days late"):gettext("on time");t.operationplan__operation__description&&(a+=gettext("description")+": "+t.operationplan__operation__description+"<br>");t.operationplan__batch&&(a+=gettext("batch")+": "+t.operationplan__batch+"<br>");if("MO"===t.operationplan__type)return gettext("manufacturing order")+"<br>"+t.operationplan__operation__name+"<br>"+gettext("reference")+": "+t.operationplan__reference+"<br>"+a+gettext("start")+": "+moment(t.operationplan__startdate).format(datetimeformat)+"<br>"+gettext("end")+": "+moment(t.operationplan__enddate).format(datetimeformat)+"<br>"+gettext("quantity")+": "+grid.formatNumber(t.operationplan__quantity)+"<br>"+gettext("criticality")+": "+Math.round(t.operationplan__criticality)+"<br>"+gettext("delay")+": "+n+"<br>"+gettext("status")+": "+gettext(t.operationplan__status)+"<br>";if("PO"===$(this).attr("data-type"))return gettext("purchase order")+"<br>"+t.operationplan__item__name+" @ "+t.operationplan__location__name+"<br>"+gettext("reference")+": "+t.operationplan__reference+"<br>"+a+gettext("start")+": "+moment(t.operationplan__startdate).format(datetimeformat)+"<br>"+gettext("end")+": "+moment(t.operationplan__enddate).format(datetimeformat)+"<br>"+gettext("quantity")+": "+grid.formatNumber(t.operationplan__quantity)+"<br>"+gettext("criticality")+": "+t.operationplan__criticality+"<br>"+gettext("delay")+": "+n+"<br>"+gettext("status")+": "+gettext(t.operationplan__status)+"<br>";if("DO"===$(this).attr("data-type"))return gettext("distribution order")+"<br>"+t.operationplan__item__name+" @ "+t.operationplan__location__name+"<br>"+gettext("origin")+": "+t.operationplan__origin__name+"<br>"+gettext("reference")+": "+t.operationplan__reference+"<br>"+a+gettext("start")+": "+moment(t.operationplan__startdate).format(datetimeformat)+"<br>"+gettext("end")+": "+moment(t.operationplan__enddate).format(datetimeformat)+"<br>"+gettext("quantity")+": "+grid.formatNumber(t.operationplan__quantity)+"<br>"+gettext("criticality")+": "+t.operationplan__criticality+"<br>"+gettext("delay")+": "+n+"<br>"+gettext("status")+": "+gettext(t.operationplan__status)+"<br>";if("STCK"===$(this).attr("data-type"))return gettext("inventory")+"<br>"+t.operationplan__item__name+" @ "+t.operationplan__location__name+"<br>"+gettext("quantity")+": "+grid.formatNumber(t.operationplan__quantity)+"<br>";if("DLVR"===$(this).attr("data-type"))return gettext("customer delivery")+"<br>"+a+t.operationplan__item__name+" @ "+t.operationplan__location__name+"<br>"+gettext("demand")+": "+t.operationplan__demand__name+"<br>"+gettext("start")+": "+moment(t.operationplan__startdate).format(datetimeformat)+"<br>"+gettext("end")+": "+moment(t.operationplan__enddate).format(datetimeformat)+"<br>"+gettext("quantity")+": "+grid.formatNumber(t.operationplan__quantity)+"<br>"+gettext("criticality")+": "+t.operationplan__criticality+"<br>"+gettext("delay")+": "+n+"<br>"+gettext("status")+": "+gettext(t.operationplan__status)+"<br>"},e.buildcolor=n,e.time2scale=r,e.duration2scale=o,e.drawGantt=i,e.$on("zoom",function(){i()}),$("#ganttheader").on("scroll",function(e){gantt.scroll(e),i()})}}}operationplandetailapp.config(["$httpProvider",function(e){e.defaults.headers.common["X-Requested-With"]="XMLHttpRequest",e.defaults.xsrfCookieName="csrftoken",e.defaults.xsrfHeaderName="X-CSRFToken"}]),operationplandetailapp.run(["gettextCatalog",function(e){e.setCurrentLanguage(language)}]),operationplandetailapp.filter("formatdate",function(){return function(e){return moment.isMoment(e)?e.format(dateformat):e&&void 0!==e?moment(e,datetimeformat).format(dateformat):void 0}}),operationplandetailapp.filter("formatdatetime",function(){return function(e){if(moment.isMoment(e))return e.year()>1971?e.format(datetimeformat):"";if(e&&void 0!==e){var t=moment(e,datetimeformat);return t.year()>1971?t.format(datetimeformat):""}}}),operationplandetailapp.filter("formatnumber",function(){return function(e,t=6){if(void 0===e)return"";var a=$.fmatter.isNumber;if(a(e)||(e*=1),a(e)){var n,r=e<0,o=Math.abs(e);n=o>1e5||t<=0?String(parseFloat(e.toFixed())):o>1e4||t<=1?String(parseFloat(e.toFixed(1))):o>1e3||t<=2?String(parseFloat(e.toFixed(2))):o>100||t<=3?String(parseFloat(e.toFixed(3))):o>10||t<=4?String(parseFloat(e.toFixed(4))):o>1||t<=5?String(parseFloat(e.toFixed(5))):String(parseFloat(e.toFixed(t)));var i=jQuery("#grid").jqGrid("getGridRes","formatter.number.decimalSeparator")||".";"."!==i&&(n=n.replace(".",i));var d=jQuery("#grid").jqGrid("getGridRes","formatter.number.thousandsSeparator")||",";if(d){var l=n.lastIndexOf(i);l=l>-1?l:n.length;var p,s=void 0===i?"":n.substring(l),c=-1;for(p=l;p>0;p--)++c%3==0&&p!==l&&(!r||p>1)&&(s=d+s),s=n.charAt(p-1)+s;n=s}return n}return e}}),angular.module("operationplandetailapp").controller("operationplandetailCtrl",operationplanCtrl),operationplanCtrl.$inject=["$scope","$http","OperationPlan","PreferenceSvc"],angular.module("operationplandetailapp").directive("showproblemspanelDrv",showproblemspanelDrv),showproblemspanelDrv.$inject=["$window","gettextCatalog"],angular.module("operationplandetailapp").directive("showresourcespanelDrv",showresourcespanelDrv),showresourcespanelDrv.$inject=["$window","gettextCatalog"],angular.module("operationplandetailapp").directive("showbufferspanelDrv",showbufferspanelDrv),showbufferspanelDrv.$inject=["$window","gettextCatalog","$filter"],angular.module("operationplandetailapp").directive("showoperationpeggingpanelDrv",showoperationpeggingpanelDrv),showoperationpeggingpanelDrv.$inject=["$window","gettextCatalog","$filter"],angular.module("operationplandetailapp").directive("showoperationplanDrv",showoperationplanDrv),showoperationplanDrv.$inject=["$window","gettextCatalog"],angular.module("operationplandetailapp").directive("showsupplyinformationDrv",showsupplyinformationDrv),showsupplyinformationDrv.$inject=["$window","gettextCatalog"],angular.module("operationplandetailapp").directive("showdownstreamoperationplansDrv",showdownstreamoperationplansDrv),showdownstreamoperationplansDrv.$inject=["$window","gettextCatalog"],angular.module("operationplandetailapp").directive("showupstreamoperationplansDrv",showupstreamoperationplansDrv),showupstreamoperationplansDrv.$inject=["$window","gettextCatalog"],angular.module("operationplandetailapp").directive("showKanbanDrv",showKanbanDrv),showKanbanDrv.$inject=["$window","gettextCatalog","OperationPlan","PreferenceSvc"],angular.module("operationplandetailapp").directive("showGanttDrv",showGanttDrv),showGanttDrv.$inject=["$window","gettextCatalog","OperationPlan","PreferenceSvc"];
//# sourceMappingURL=frepple-operationplandetail.min.js.map